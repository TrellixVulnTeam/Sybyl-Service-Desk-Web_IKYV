{% extends 'base.html' %}
{% load static %}
{% block content %}
<!-- Main wrapper  -->
<div id="main-wrapper">
	{% include 'header.html' %}
	{% include 'left-nav.html' %}
	<!-- Page wrapper  -->
	<div class="page-wrapper">
		<!-- Bread crumb -->
		<div class="row page-titles">
			<div class="col-md-5 align-self-center">
				<h3 class="text-primary">Incidents</h3>
			</div>
			<div class="col-md-7 align-self-center">
				<ol class="breadcrumb">
					<li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
					<li class="breadcrumb-item active">List of Incidents</li>
				</ol>
			</div>
		</div>
		<!-- End Bread crumb -->
		<!-- Container fluid  -->
		<div class="container-fluid">
			<!-- Start Page Content -->
			<div class="row">
				<div class="col-12">
					<div class="card">
						<div class="card-body">
							<div class="row">
								<div class="col-10">
									<h4 class="card-title">Incidents</h4>
								</div>

								<div class="col-2">
									<button id="" class="btn btn-info pull-right" onclick="functAddIncident();">
										<i class="fa fa-fw fa-lg fa-plus"></i>Add Incident
									</button>
								</div>
							</div>
							<br />
							<!-- <h6 class="card-subtitle">Export data to Copy, CSV, Excel, PDF & Print</h6> -->
							<div class="table-responsive">
								<table id="table_incidents" class="display nowrap table table-hover" cellspacing="0"
									width="100%">
									<thead>
										<tr>
											<th>Title</th>
											<th>Status</th>
											<th>Priority</th>
											<th>Creator</th>
											<th>Assignee</th>
											<th>Elapsed time</th>
											<th>Action</th>
										</tr>
									</thead>
									<tbody>
										{% for incident in all_incidents %}
										<tr id="{{ incident.id }}" data-created="{{ incident.created_time|date }}">
											<td>{{ incident.title }}</td>
											<td>{{ incident.status }}</td>
											<td>
												<input id="incident-priority" value="{{ incident.priority}}" type="text" style="background-color: {{ incident.priority.color }}; border: 0; color:white;">
											</td>
											<td>{{ incident.creator }}</td>
											
											<td class="text-center">
												<span class="badge badge-pill badge-success">{{ incident.assigned }}</span>
											</td>
											<td id="elapsed{{ incident.id }}"></td>
											<td>
												<a href="{% url 'detailsIncident' incident.id %}">View</a>
												&nbsp; 
												<a href="{% url 'updateIncident' incident.id %}">Update</a>
												&nbsp; 
												<a href="#"><i class="mdi mdi-delete font-30 align-middle mr-2"></i></a>
											</td>
											<input type="text" value="{{ incident.created_time|date }}" style="display: none;" class='id_elapsed' />
										</tr>
										{% endfor %}
									</tbody>
								</table>
							</div>
							<br />
						</div>
					</div>
					{% include 'footer.html' %}
					<!-- End Page Content -->
				</div>
				<!-- End Container fluid  -->

			</div>
			<!-- End Page wrapper  -->
		</div>

		<!-- The Modal -->
		<div class="">
				<div id="incidentFormModalDialog" class="modalDialog">
					<div>
						<div id="head">
							<a href="#close" title="Close" class="close2">X</a>
							<h5 class="modalDialog-title">Add Incident</h5>
						</div>
						<hr>
		
						<div class="modal-body">
		
							<div class="scrollbar-modal1">
								<div id="dialog_create_incident">
		
								</div>
							</div>
						</div>
		
					</div>
				</div>
			</div>
			<!-- END The Modal -->

			<style>
				#incident-priority{
					padding: 5px;
					text-transform: uppercase;
					text-align: center;
					border-radius: 5px;
					width: 60%;
				}
			</style>
			
			<script>
				function functAddIncident() {
					urldata = "{% url 'addIncident'%}";
					$.ajax({
						type: "GET",
						cache: false,
						data: {},
						url: urldata,
						success: function (resp) {
							$('#dialog_create_incident').html(resp);

							window.location = '#incidentFormModalDialog';
							initDialog('modalDialog');
						}
					});
				}

				function dhm(ms){
					var days = Math.floor(ms / (24*60*60*1000));
					var daysms=ms % (24*60*60*1000);
					var hours = Math.floor((daysms)/(60*60*1000));
					var hoursms=ms % (60*60*1000);
					var minutes = Math.floor((hoursms)/(60*1000));
					var minutesms=ms % (60*1000);
					var sec = Math.floor((minutesms)/(1000));
					
					if (days == 1){
						var day = days;
						return day+" day";
					}
					if (days > 1){
						var day = days;   
						return day +" days";
					}
					if (days < 1){
						if (hours < 1){
							if (minutes >= 60){
								var hour_min = hours;
								return hour_min + " hour";
							}
							else if (minutes < 60){
								var minimum = minutes;
								var second = seconds;
								return minimum +" mins " + second + " seconds";
							}
						}
						else if(hours >=1 ){
							var hr = hours;
							var min = minutes;
							return hr+" h " + min + " mins";
						}
						
					}
				}

				$('#table_incidents tr').each(function(){
					var row_id = this.id;
					var created_time = $(this).data('created'); 

					var created = Date.parse(created_time)
					var date_today =  new Date();
					var elapsed_time = date_today - created;

					var changed = dhm(elapsed_time)
					$('#elapsed'+row_id).html(changed);
				}); 
			</script>
		{% endblock %}